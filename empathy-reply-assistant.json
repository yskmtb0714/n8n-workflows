{
  "nodes": [
    {
      "parameters": {},
      "id": "2d9b9343-a632-4fb5-ba50-b652483b6ee1",
      "name": "When clicking 'Test workflow'",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        608,
        336
      ]
    },
    {
      "parameters": {
        "content": "## ğŸ¯ Empathy Reply Assistant (EN)\n\n### What this template does\nAnalyzes customer or user messages and produces **empathetic, professional replies** â€” balancing emotional awareness with actionable clarity.  \nIt detects tone, drafts natural responses, sanitizes output, and **auto-escalates** risky or low-confidence cases.\n\n### Who this is for\n- ğŸ’¬ Customer support & helpdesk teams  \n- ğŸ“± Social media or community managers  \n- ğŸ’¼ Sales or CX automation builders  \n- ğŸ¤– Anyone designing human-like AI communication flows  \n\n### How it works\n1. **Receive input** (via Test node or webhook)  \n2. **AI Agent (Empathy)** detects sentiment & generates reply  \n3. **Post-Process & Sanitize** removes URLs, emojis, PII  \n4. **Risk & Handover Rules** evaluates escalation triggers  \n5. **If node** routes to either â€œOKâ€ or â€œNeeds Reviewâ€ output  \n\n### Auto-escalation triggers\n- ğŸš© Negative sentiment detected  \n- âš ï¸ Risk words matched (e.g. *refund, lawsuit, abuse, self-harm*)  \n- â— Confidence score < 0.45  \n- ğŸ§¨ Mentions of legal or harassment context  \n\n### Configuration\nEdit **Set Config** to adjust:  \n- `MAX_LEN` â†’ Maximum reply length (default: 600)  \n- `ADD_FOLLOWUP_QUESTION` â†’ End with a question (default: true)  \n- `FORMALITY` â†’ auto / casual / polite  \n- `EMOJI_ALLOWED` â†’ Include emojis? (default: false)  \n- `BLOCK_LINKS` â†’ Remove URLs & hashtags (default: true)  \n- `RISK_WORDS` â†’ Add or update escalation keywords  \n\n### Example output\n```json\n{\n  \"sentiment\": \"negative\",\n  \"tone\": \"apologetic\",\n  \"reply\": \"Iâ€™m sorry this happened. Let me look into it right away so we can resolve it together.\",\n  \"confidence\": 0.82,\n  \"needs_handover\": true,\n  \"status\": \"REVIEW\",\n  \"note\": \"Escalate to human: risk or low confidence detected.\"\n}",
        "height": 1072,
        "width": 1024
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -64,
        -848
      ],
      "typeVersion": 1,
      "id": "f7db2235-751b-42d3-84c9-0371ebbaefa9",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### Notes & best practices\nâ€¢\tğŸ” No hardcoded API keys â€” use n8nâ€™s credential manager.\nâ€¢\tğŸ§© Works with self-hosted or cloud n8n.\nâ€¢\tğŸ§ª Use this for draft generation, not final unsupervised sending.\nâ€¢\tâš™ï¸ Tune RISK_WORDS and confidence threshold to match your orgâ€™s policy.\nâ€¢\tğŸ“¡ Optional: Connect â€œREVIEWâ€ path to Slack / email alerts.\n\n### Author\n**Yusuke M. (@yskautomation)** â€” AI Automation Architect  \n**License:** MIT  \n**Version:** 1.0 (2025-11-04)  \n**Source:** [github.com/yskautomation/n8n-workflows](https://github.com/yskautomation/n8n-workflows)",
        "height": 272,
        "width": 544
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -64,
        320
      ],
      "typeVersion": 1,
      "id": "754a3386-93cf-40bb-906a-9e4488219cdb",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Setup checklist\n- âœ… Connect **Anthropic** credential to **Anthropic Chat Model**  \n  - Model: **Claude 4 Sonnet (2025-05-14)**  \n- ğŸ§© Review **Set Config1** and confirm:\n  - `MAX_LEN`: Maximum reply length (default **600**)  \n  - `ADD_FOLLOWUP_QUESTION`: Append a soft question (true/false)  \n  - `FORMALITY`: `auto`, `casual`, or `polite`  \n  - `EMOJI_ALLOWED`: Whether to keep emojis (default **false**)  \n  - `BLOCK_LINKS`: Remove URLs (default **true**)  \n  - `RISK_WORDS`: Phrases that trigger human review  \n- ğŸ”— Ensure **AI Agent (Empathy, EN)1** is connected to:\n  - **Anthropic Chat Model** (language model)  \n  - **Structured Output Parser1** (schema enforcement)  \n  - **Memory (Recent 4)1** (context retention)  \n- âš™ï¸ Replace **Manual Trigger** with a **Webhook Trigger** or **Schedule Trigger** for production:\n  - **Webhook** â†’ best for real-time incoming messages (e.g., chat or form input)  \n  - **Schedule** â†’ best for periodic inbox scans (e.g., Gmail or Slack every 5 min)  \n  - Keep **Manual Trigger** for testing only  \n- ğŸ§ª Test using **When clicking â€˜Test workflowâ€™** to confirm flow integrity.  \n- ğŸ“¤ Validate output in:\n  - **Draft (Auto-OK)1** â†’ automatically approved replies  \n  - **Draft (Needs Review)1** â†’ human-escalated messages  \n- (Optional) Connect **Slack** or **Notion** nodes for logging, review, or escalation tracking.  \n- ğŸ§­ Recommended hybrid setup:\n  - **Webhook Trigger** for real-time replies  \n  - **Schedule Trigger** (5â€“10 min) for missed or queued messages  \n  - **Manual Trigger** for safe local testing",
        "height": 720,
        "width": 560,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        992,
        -848
      ],
      "typeVersion": 1,
      "id": "b2c3e495-dbeb-4b59-a9ce-b6eaed203f82",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Security & review\n- ğŸ” No API keys or secrets hardcoded â€” use **n8n credentials**.  \n- ğŸ§± Keep configuration centralized in **Set Config1** for clarity.  \n- ğŸ§¹ Remove any personal text samples or client data before sharing.  \n- ğŸ§ª Use diverse test cases (positive, negative, neutral, high-risk).  \n- âš™ï¸ Adjust confidence threshold in **Risk & Handover Rules1** (`0.45` by default).  \n- ğŸ§­ If sentiment detection is off, retrain prompt or reduce context memory to avoid bias.  \n\n**Author:** Yusuke M. (@yskautomation) â€” AI Automation Architect  \n**License:** MIT",
        "height": 256,
        "width": 560,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        992,
        -80
      ],
      "typeVersion": 1,
      "id": "dfee124a-c5f4-450e-9db9-3d99cd1dd5f1",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"text\": \"I'm really frustrated with your service. This is the third time I've had issues and nobody is helping me!\"\n}",
        "options": {}
      },
      "id": "ac9638bd-e82e-473c-935d-77387f0827c6",
      "name": "Test Input (Change Me)1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        832,
        336
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"MAX_LEN\": 600,\n  \"ADD_FOLLOWUP_QUESTION\": true,\n  \"FORMALITY\": \"auto\",\n  \"EMOJI_ALLOWED\": false,\n  \"SIGNOFF\": \"\",\n  \"BLOCK_LINKS\": true,\n  \"RISK_WORDS\": [\n    \"refund\",\"chargeback\",\"lawsuit\",\"harassment\",\"self-harm\",\"suicide\",\"abuse\",\n    \"threat\",\"racist\",\"illegal\",\"hate\",\"scam\"\n  ]\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "id": "3972b891-6ef7-4f31-915c-7b290932b36e",
      "name": "Set Config1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1056,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "const j = $input.first().json || {};\nconst sid = j.sessionId || 'test-session-1';\nconst text = j.text || j.message || j.input || JSON.stringify(j);\nreturn [{ json: { ...j, sessionId: String(sid), text } }];"
      },
      "id": "546540d3-8889-4a5b-a06f-19322d9b386b",
      "name": "Ensure Session1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1280,
        336
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an Empathy Reply Assistant for English-language messages.\nAnalyze the incoming text:\n<Text>{{ $json.text || $json.message || $json.input || JSON.stringify($json) }}</Text>\n\nGoals:\n1) Detect `sentiment` (positive|neutral|negative|mixed)\n2) Choose a natural human `tone` that fits the sender (warm, calm, upbeat, apologetic, confident, concise)\n3) Draft a short `reply` (<= {{ $('Set Config1').item.json.MAX_LEN }} chars) that:\n   - acknowledges the emotion first in plain English\n   - provides a practical next step or clarification\n   - {{ $('Set Config1').item.json.ADD_FOLLOWUP_QUESTION ? 'ends with a gentle question' : 'may end without a question' }}\n   - uses **no links**, **no hashtags**\n   - matches formality: {{ $('Set Config1').item.json.FORMALITY }} (auto|casual|polite)\n\nReturn **JSON only** with keys: sentiment, tone, reply, confidence (0.0â€“1.0), needs_handover (boolean).",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Role: Empathetic, practical, concise. Avoid corporate cliches. Keep it in English. No URLs or hashtags."
        }
      },
      "id": "9f4b03fa-aa22-4cca-a71b-b8d5fa505e45",
      "name": "AI Agent (Empathy)1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        1568,
        336
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-3-5-sonnet-latest",
          "cachedResultName": "Claude 3.5 Sonnet (latest)"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        1504,
        560
      ],
      "id": "a9afe8de-3810-4b2b-978e-a30f22f487f5",
      "name": "Anthropic Chat Model1"
    },
    {
      "parameters": {
        "contextWindowLength": 4
      },
      "id": "1badd599-1d2a-484f-8219-3f03951c2ad4",
      "name": "Memory (Recent 4)",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1632,
        560
      ]
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"sentiment\": \"positive|neutral|negative|mixed\",\n  \"tone\": \"warm|calm|upbeat|apologetic|confident|concise\",\n  \"reply\": \"string\",\n  \"confidence\": 0.0,\n  \"needs_handover\": false\n}"
      },
      "id": "6799d4c5-da73-4415-9d26-c87adfe0d990",
      "name": "Structured Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1760,
        560
      ]
    },
    {
      "parameters": {
        "jsCode": "// Read config from Set Config node (stable across items)\nconst cfgNode = $nodes['Set Config']?.data?.json || {};\nconst cfg = {\n  MAX_LEN: Number(cfgNode.MAX_LEN ?? 600),\n  EMOJI_ALLOWED: cfgNode.EMOJI_ALLOWED === false ? false : Boolean(cfgNode.EMOJI_ALLOWED),\n  SIGNOFF: String(cfgNode.SIGNOFF ?? ''),\n  BLOCK_LINKS: cfgNode.BLOCK_LINKS === undefined ? true : Boolean(cfgNode.BLOCK_LINKS)\n};\n\nconst input = $input.first().json || {};\nlet out = { ...input };\n\nout.sentiment = (out.sentiment || '').toLowerCase();\nout.tone = (out.tone || '').toLowerCase();\nout.reply = (out.reply || '').toString();\nout.confidence = (typeof out.confidence === 'number') ? out.confidence : 0.6;\nout.needs_handover = !!out.needs_handover;\n\nif (cfg.BLOCK_LINKS) {\n  out.reply = out.reply\n    .replace(/https?:\\/\\/\\S+/gi, '')\n    .replace(/#[\\w-]+/g, '')\n    .replace(/\\s{2,}/g, ' ');\n}\n\nif (cfg.EMOJI_ALLOWED === false) {\n  out.reply = out.reply.replace(/[\\p{Extended_Pictographic}\\p{Emoji_Component}]/gu, '');\n}\n\nout.reply = out.reply\n  .replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}/ig, '[email hidden]')\n  .replace(/\\b\\+?\\d[\\d\\s().-]{6,}\\b/g, '[phone hidden]');\n\nconst maxLen = Number(cfg.MAX_LEN || 600);\nif (out.reply.length > maxLen) {\n  out.reply = out.reply.slice(0, maxLen - 1).replace(/\\s+\\S*$/, '') + 'â€¦';\n}\n\nif (cfg.SIGNOFF && !/\\b(best|thanks|regards)\\b/i.test(out.reply)) {\n  out.reply = out.reply.trim() + \"\\n\" + cfg.SIGNOFF;\n}\n\nreturn [{ json: out }];"
      },
      "id": "61a412c9-801c-4d5d-822a-8499a26d2607",
      "name": "Post-Process & Sanitize1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1968,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "// Read RISK_WORDS from Set Config node\nconst cfgNode = $nodes['Set Config']?.data?.json || {};\nconst riskWords = Array.isArray(cfgNode.RISK_WORDS) ? cfgNode.RISK_WORDS : [];\n\nconst escapeRegex = (s) => String(s).replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\nconst riskPattern = riskWords.length ? '(' + riskWords.map(escapeRegex).join('|') + ')' : '(?!)';\nconst risk = new RegExp(riskPattern, 'i');\n\nconst j = $input.first().json || {};\nconst originalText = j.text || j.message || j.input || '';\n\nconst lowConfidence = (j.confidence || 0) < 0.45;\nconst highRisk = risk.test(originalText) || risk.test(j.reply || '');\nconst veryNegative = (j.sentiment || '') === 'negative';\n\nconst needsHandover = Boolean(j.needs_handover || lowConfidence || highRisk || veryNegative);\n\nreturn [{ json: { ...j, needs_handover: needsHandover, _debug: { lowConfidence, highRisk, veryNegative, originalText: String(originalText).substring(0,120), riskWordsUsed: riskWords } } }];"
      },
      "id": "c255267c-5dfb-47d9-9c9a-9a7ae4ada264",
      "name": "Risk & Handover Rules1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        336
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needs_handover }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "id": "e2876b8a-248f-41a9-95f2-cbb235ad7071"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "7aae0aff-287e-4c5c-b6d4-c2e5b42e2efb",
      "name": "If needs_handover1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2416,
        336
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "status",
              "type": "string",
              "value": "REVIEW"
            },
            {
              "id": "a2",
              "name": "note",
              "type": "string",
              "value": "Escalate to human: risk/low-confidence/negative tone detected."
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "42085b59-d2d1-443b-9699-dbbe3ce86acf",
      "name": "Draft (Needs Review)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2640,
        240
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b1",
              "name": "status",
              "type": "string",
              "value": "OK"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "529f1815-7913-424d-8908-ff282ceabcdd",
      "name": "Draft (Auto-OK)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2640,
        432
      ]
    },
    {
      "parameters": {
        "path": "7a62325a-0000-4724-8fe4-8829e3dea2fb",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        608,
        528
      ],
      "id": "9517622f-10ae-4597-81e6-4b426d266e4c",
      "name": "for real-time replies",
      "webhookId": "7a62325a-0000-4724-8fe4-8829e3dea2fb"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        608,
        688
      ],
      "id": "50a47075-c245-46f5-a103-9c240c03f519",
      "name": "(5â€“10 min) for missed or queued"
    },
    {
      "parameters": {
        "operation": "update",
        "channelId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "updateFields": {},
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        2864,
        432
      ],
      "id": "66b91934-ac03-4d78-a816-052aebae5d8a",
      "name": "Update a message",
      "webhookId": "d03b31ff-3de4-4953-a091-7445a6c48be5"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": "={{ $('Config1').item.json.SPREADSHEET_ID }}",
        "sheetName": "={{ $('Config1').item.json.SHEET_NAME }}",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Workflow": "={{ $json.workflow_name }}",
            "Repository": "={{ $json.repository }}",
            "Stars": "={{ $json.stars }}",
            "Nodes": "={{ $json.nodes }}",
            "Node Types": "={{ $json.node_types }}",
            "AI Powered": "={{ $json.has_ai }}",
            "Key Nodes": "={{ $json.key_nodes }}",
            "Use Case": "={{ $json.ai_use_case }}",
            "Difficulty": "={{ $json.ai_difficulty }}",
            "Repo URL": "={{ $json.repo_url }}",
            "File URL": "={{ $json.file_url }}",
            "AI Summary": "={{ $json.description }}"
          },
          "matchingColumns": [
            "Workflow"
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "0dc9f0d7-38ff-4cf0-919e-c6d87b93168d",
      "name": "Save to Google Sheets1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        2864,
        240
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "lQPBplQIZUZ1JZ5k",
          "name": "Google Sheets account 3"
        }
      }
    }
  ],
  "connections": {
    "When clicking 'Test workflow'": {
      "main": [
        [
          {
            "node": "Test Input (Change Me)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Test Input (Change Me)1": {
      "main": [
        [
          {
            "node": "Set Config1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Config1": {
      "main": [
        [
          {
            "node": "Ensure Session1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ensure Session1": {
      "main": [
        [
          {
            "node": "AI Agent (Empathy)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Empathy)1": {
      "main": [
        [
          {
            "node": "Post-Process & Sanitize1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Anthropic Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Empathy)1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory (Recent 4)": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (Empathy)1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent (Empathy)1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Post-Process & Sanitize1": {
      "main": [
        [
          {
            "node": "Risk & Handover Rules1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Risk & Handover Rules1": {
      "main": [
        [
          {
            "node": "If needs_handover1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If needs_handover1": {
      "main": [
        [
          {
            "node": "Draft (Needs Review)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Draft (Auto-OK)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "for real-time replies": {
      "main": [
        [
          {
            "node": "Test Input (Change Me)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "(5â€“10 min) for missed or queued": {
      "main": [
        []
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "cb6a5c207772ff185d6f50424ee0baf7d8ab8449011e139b3b983206d2202a31"
  }
}
